<div class="mb-4">
  <%= link_to "â† Back to Dashboard", root_path,
    class: "inline-block bg-gray-200 text-gray-800 hover:bg-gray-300 px-4 py-2 rounded text-sm" %>
</div>

<h1 class="text-2xl font-bold text-blue-700 mb-6">Inventory Scanner</h1>

<!-- QR Scanner -->
<div id="qr-reader" class="mb-6 w-full max-w-md"></div>

<%= form_with url: inventory_scan_path, method: :get, local: true, html: { id: "scan-form" } do %>
  <input type="hidden" name="sku" id="sku" />
<% end %>
<div class="mb-6">
  <label class="block text-sm font-medium text-gray-700 mb-1">Scan from Image</label>
  <input type="file" id="qr-file-input" accept="image/*"
         class="block w-full border px-3 py-2 rounded text-sm" />
</div>

<!-- Flash Messages -->
<% if flash[:notice] %>
  <div class="bg-green-100 text-green-800 p-3 mb-4 rounded"><%= flash[:notice] %></div>
<% elsif flash[:alert] %>
  <div class="bg-red-100 text-red-800 p-3 mb-4 rounded"><%= flash[:alert] %></div>
<% end %>

<!-- Product Display -->
<% if @product %>
  <div class="bg-white p-4 rounded shadow-md w-full max-w-md">
    <h2 class="text-lg font-bold text-gray-800 mb-2"><%= @product.name %></h2>
    <p class="text-sm text-gray-600 mb-4">SKU: <%= @product.sku %></p>
    <p class="text-sm text-gray-600 mb-4">Quantity: <%= @product.quantity %></p>

    <%= form_with url: inventory_sell_path, method: :post, local: true do %>
      <%= hidden_field_tag :sku, @product.sku %>
      <%= submit_tag "Mark as Sold", class: "bg-blue-500 hover:bg-blue-700 text-white px-4 py-2 rounded" %>
    <% end %>
  </div>
<% end %>

<!-- QR Scanner JS -->
<script src="https://unpkg.com/html5-qrcode"></script>
<script>
  const scanner = new Html5Qrcode("qr-reader");

  Html5Qrcode.getCameras().then(devices => {
    if (devices.length) {
      scanner.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        qrCodeMessage => {
          // Extract SKU from the scanned text using regex
          const match = qrCodeMessage.match(/SKU:\s*(\w+)/);
          if (match && match[1]) {
            document.getElementById("sku").value = match[1];
            document.getElementById("scan-form").submit();
          } else {
            alert("Invalid QR code format. SKU not found.");
          }
        },
        error => {
          // Ignore scan errors
        }
      );
    }
  }).catch(err => {
    alert("Camera access error: " + err);
  });
</script>

<script>
  const fileInput = document.getElementById("qr-file-input");

  fileInput.addEventListener("change", event => {
    const file = event.target.files[0];
    if (!file) return;

    const qrCodeScanner = new Html5Qrcode("qr-reader");
    
    qrCodeScanner.scanFile(file, true)
      .then(qrCodeMessage => {
        const match = qrCodeMessage.match(/SKU:\s*(\w+)/);
        if (match && match[1]) {
          document.getElementById("sku").value = match[1];
          document.getElementById("scan-form").submit();
        } else {
          alert("Invalid QR format. Could not extract SKU.");
        }
      })
      .catch(err => {
        alert("Failed to scan file: " + err);
      });
  });
</script>
